## Технологии
#### База данных
Простейшая база данных реализации ii состоит из двух каталогов: echo/ и msg/. В msg/ хранятся сами сообщения, имена файлов (они же номера сообщений или msgid). Msgid - уникальный номер, который генерируется станцией, как 20 первых символов base64 sha256-bin хэша сообщения. В echo/ хранятся индексы сообщений: там находятся файлы эхоконференций (имя файла = название эхи).

Файл в echo/<эха> состоит из списка имён файлов сообщений, находящихся в msg/, по порядку, в конце пустая строка. Из-за простой структуры базы данных сообщения можно передавать даже оффлайн, на флешке: достаточно лишь положить сообщение в msg/ и в файле эхоконференции прописать его хэш (вручную или простейшим скриптом).

Хранить файлы на самом деле можно и в json, и в sqlite, и в любом другом формате.

#### Получение данных

Получить данные из нужных эх может любой пользователь, авторизованный или нет. Сначала нужно получить список сообщений эхи, и потом загрузить недостающие сообщения, которых ещё нет в базе данных. Подобным образом могут получать данные любые пойнты, и так же, настроив взаимное получение данных друг с друга, обмениваться между собой ноды.

#### бандл (нод2нод)
Бандл - это полное, сформированное сообщение, уже имеющее идентификатор. В отличие от просто получения сообщения по его номеру, бандл уже содержит и само сообщение (и, возможно, не одно).

Формат бандла - строка **НОМЕРСООБЩЕНИЯ:BASE64код**. В base64 и закодировано само сообщение - файл, идентичный лежащему в msg/

По умолчанию, при распаковке, бандл создаёт все эхи, которые указаны в заголовках. То есть, распаковка бандла - это команда создать такое сообщение и прописать его во все эхи.

Бандлу не нужен онлайн. Можно создать бандл со всеми нужными сообщениями и передать его любым способом - после его распаковки в базе создадутся все сообщения.

Пойнты никогда не генерируют бандлы для нод, у них свои бандлы (называемые msgline)

#### Формат хранимого сообщения в /msg (и текста в бандле)
<table>
<tr><th>строка</th><th>поле</th><th>описание</th></tr>
<tr><td>1</td><td>разные тэги в виде: имя/значение/имя2/значение</td><td>в текущем виде используются только для repto и для рекомендуемого идентификатора ii/ok</td></tr>
<tr><td>2</td><td>echoarea</td><td>основная эхоконференция, в которую помещается сообщение</td></tr>
<tr><td>3</td><td>date</td><td>число секунд от эпохи unix, в utc</td></tr>
<tr><td>4</td><td>msgfrom</td><td>отправитель сообщения</td></tr>
<tr><td>5</td><td>addr</td><td>адрес отправителя сообщения</td></tr>
<tr><td>6</td><td>msgto</td><td>пользователь, которому предназначено сообщение (либо All)</td></tr>
<tr><td>7</td><td>subj</td><td>тема сообщения</td></tr>
<tr><td>8</td><td>-</td><td>пустая строка</td></tr>
<tr><td>9 и далее</td><td>msg</td><td>текст сообщения</td></tr>
</table>
Формат кодирования:

**ИДЕНТИФИКАТОР:СТРОКА**

где СТРОКА - это просто текстовый файл, кодированный base64, а ИДЕНТИФИКАТОР - номер сообщения, обеспечивающий его уникальность.
Разделитель нескольких сообщений - новая линия (LF, код 10).

#### Формат сообщения, которое отправляют пойнты (msgline)
<table>
<tr><th>строка</th><th>поле</th><th>описание</th></tr>
<tr><td>1</td><td>echoarea</td><td>эхоконференция, в которую помещается сообщение</td></tr>
<tr><td>2</td><td>msgto</td><td>пользователь, которому предназначено сообщение (либо All)</td></tr>
<tr><td>3</td><td>subj</td><td>тема сообщения</td></tr>
<tr><td>4</td><td>-</td><td>пустая строка</td></tr>
<tr><td>5</td><td>repto</td><td>если начинается с @repto:, то проставляет тэг repto. Иначе строка относится к тексту сообщения</td></tr>
<tr><td>6 и далее</td><td>msg</td><td>текст сообщения</td></tr>
</table>
Формат кодирования:

**СТРОКА**

где СТРОКА - это просто текстовый файл, кодированный base64
**Внимание!** Пустое поле *subj* и/или пустой текст сообщения не допускаются.

#### Стандарты

Имя эхи - от 3 до 120 символов: маленькие латинские буквы, цифры, символы подчёркивания, минуса и точки. Название должно содержать минимум одну точку. В старых версиях обязано заканчиваться на точку и число. Разные фильтры могут устанавливать разные ограничения, поэтому придерживайтесь пределов разумного при создании своих эх.

Примеры правильных названий эх: 1.1 ii.14 ii.about.14 to.ivan.15, my.beseda

Адрес практического смысла не имеет, служит для того чтобы узнавать, с какой станции пришло сообщение.
